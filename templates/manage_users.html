{% extends 'base.html' %} {% block content %}
<br />
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <h1 class="text-white text-center">Manage Users</h1>
      <br />
      <div id="flashMessages"></div>
      <table
        class="table table-dark table-striped table-bordered"
        style="color: white"
      >
        <thead class="thead-dark">
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Admin</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody class="tbody-dark">
          {% for user in users %}
          <tr>
            <td>{{ user.id }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.is_admin }}</td>
            <td>
              <a href="#" class="delete-user" data-user-id="{{ user.id }}"
                >Delete</a
              >
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $(".delete-user").click(function (e) {
      e.preventDefault();
      var userId = $(this).data("user-id");
      var confirmation = confirm("Are you sure you want to delete this user?");
      if (confirmation) {
        var url = "/api/delete_user/" + userId;
        $.ajax({
          url: url,
          type: "POST",
          success: function (response) {
            if (response.success) {
              // Store success flash message in local storage
              localStorage.setItem(
                "flashMessage",
                JSON.stringify({
                  type: "success",
                  message: "User deleted successfully",
                })
              );
            } else {
              // Store warning flash message in local storage
              localStorage.setItem(
                "flashMessage",
                JSON.stringify({
                  type: "warning",
                  message: "Failed to delete user",
                })
              );
            }
            // Reload the page
            location.reload();
          },
          error: function (xhr, status, error) {
            console.log("Error deleting user:", error);
            // Store error flash message in local storage
            localStorage.setItem(
              "flashMessage",
              JSON.stringify({
                type: "danger",
                message: "An error occurred while deleting user",
              })
            );
            // Reload the page
            location.reload();
          },
        });
      }
    });

    function showFlashMessage(type, message) {
      var alertClass = "alert-" + type;
      var flashMessage = $("<div>")
        .addClass("alert " + alertClass)
        .text(message);
      $("#flash-messages").append(flashMessage);
    }

    // Retrieve and display flash message after page reload
    var storedFlashMessage = localStorage.getItem("flashMessage");
    if (storedFlashMessage) {
      var flashMessage = JSON.parse(storedFlashMessage);
      showFlashMessage(flashMessage.type, flashMessage.message);
      // Remove flash message from local storage
      localStorage.removeItem("flashMessage");
    }
  });
</script>

{% endblock %}
